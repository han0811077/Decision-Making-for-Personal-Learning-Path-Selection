import streamlit as st
import pandas as pd
import numpy as np
import plotly.express as px

def main():
    st.set_page_config(page_title="å­¦ä¹ è·¯å¾„å†³ç­–ç³»ç»Ÿ", page_icon="ğŸ“š", layout="wide")
    
    st.title("ğŸŒ³ ä¸ªäººå­¦ä¹ è·¯å¾„é€‰æ‹©å†³ç­–ç³»ç»Ÿ")
    st.markdown("åŸºäºå¤šå› ç´ åˆ†æçš„æ™ºèƒ½å­¦ä¹ æ¨è")
    st.markdown("---")
    
    # ä¾§è¾¹æ  - ç”¨æˆ·è¾“å…¥
    st.sidebar.header("ğŸ” è¯·è¾“å…¥æ‚¨çš„å­¦ä¹ æ¡ä»¶")
    
    with st.sidebar:
        time_available = st.selectbox(
            "æ¯æ—¥å¯ç”¨å­¦ä¹ æ—¶é—´",
            ["1å°æ—¶ä»¥ä¸‹", "1-2å°æ—¶", "2-4å°æ—¶", "4å°æ—¶ä»¥ä¸Š"]
        )
        
        knowledge_level = st.selectbox(
            "å½“å‰çŸ¥è¯†æ°´å¹³",
            ["é›¶åŸºç¡€", "åˆçº§", "ä¸­çº§", "é«˜çº§"]
        )
        
        budget = st.slider("æ¯æœˆå­¦ä¹ é¢„ç®—(å…ƒ)", 0, 2000, 500)
        urgency = st.selectbox("å­¦ä¹ ç›®æ ‡ç´§è¿«åº¦", ["å®½æ¾", "ä¸­ç­‰", "ç´§æ€¥"])
        learning_style = st.selectbox("å­¦ä¹ é£æ ¼åå¥½", ["è§†è§‰å‹", "å¬è§‰å‹", "åŠ¨æ‰‹å‹", "é˜…è¯»å‹"])
    
    # å†³ç­–åˆ†æ
    recommendation, confidence, reasoning = analyze_learning_path(
        time_available, knowledge_level, budget, urgency, learning_style
    )
    
    # æ˜¾ç¤ºç»“æœ
    st.header("ğŸ¯ ä¸ªæ€§åŒ–å­¦ä¹ æ¨è")
    col1, col2, col3 = st.columns(3)
    
    with col1:
        st.metric("æ¨èæ–¹æ¡ˆ", recommendation)
    with col2:
        st.metric("æ¨èç½®ä¿¡åº¦", f"{confidence}%")
    with col3:
        effectiveness = calculate_expected_effectiveness(recommendation)
        st.metric("é¢„æœŸæ•ˆæœ", f"{effectiveness}/100")
    
    # æ˜¾ç¤ºè¿›åº¦æ¡
    st.progress(confidence/100)
    
    # å†³ç­–æ¨ç†è¿‡ç¨‹
    st.subheader("ğŸ” å†³ç­–æ¨ç†è¿‡ç¨‹")
    for i, step in enumerate(reasoning, 1):
        st.info(f"{i}. {step}")
    
    # å†³ç­–æ ‘å¯è§†åŒ–
    display_decision_tree_visualization()
    
    # æ•ˆç”¨å€¼å¯¹æ¯”
    display_utility_comparison()
    
    # è¯¦ç»†åˆ†ææŠ¥å‘Š
    show_detailed_analysis(time_available, knowledge_level, budget, urgency, learning_style)

def analyze_learning_path(time, level, budget, urgency, style):
    """åˆ†æå­¦ä¹ è·¯å¾„å¹¶è¿”å›æ¨è"""
    reasoning = []
    scores = []
    
    # æ—¶é—´å› ç´ åˆ†æ
    if time in ["1å°æ—¶ä»¥ä¸‹", "1-2å°æ—¶"]:
        reasoning.append("â° **æ—¶é—´åˆ†æ**: æ¯æ—¥å¯ç”¨æ—¶é—´æœ‰é™ï¼Œæ¨èç¢ç‰‡åŒ–å­¦ä¹ æ–¹æ¡ˆ")
        base_method = "å¾®å­¦ä¹ "
        scores.append(0.7)
    else:
        reasoning.append("â° **æ—¶é—´åˆ†æ**: æ¯æ—¥å­¦ä¹ æ—¶é—´å……è¶³ï¼Œé€‚åˆç³»ç»ŸåŒ–æ·±åº¦å­¦ä¹ ")
        base_method = "ç³»ç»Ÿå­¦ä¹ "
        scores.append(0.9)
    
    # çŸ¥è¯†æ°´å¹³åˆ†æ
    if level in ["é›¶åŸºç¡€", "åˆçº§"]:
        reasoning.append("ğŸ“ **åŸºç¡€åˆ†æ**: å½“å‰åŸºç¡€è¾ƒå¼±ï¼Œéœ€è¦åˆ†å±‚æ¸è¿›å¼æ•™å­¦")
        knowledge_method = "åˆ†å±‚æ•™å­¦"
        scores.append(0.6)
    else:
        reasoning.append("ğŸ“ **åŸºç¡€åˆ†æ**: å·²æœ‰æ‰å®åŸºç¡€ï¼Œé€‚åˆé¡¹ç›®é©±åŠ¨å­¦ä¹ ")
        knowledge_method = "é¡¹ç›®å®è·µ"
        scores.append(0.8)
    
    # é¢„ç®—åˆ†æ
    if budget < 300:
        reasoning.append("ğŸ’° **é¢„ç®—åˆ†æ**: é¢„ç®—æœ‰é™ï¼Œä¼˜å…ˆåˆ©ç”¨å…è´¹ä¼˜è´¨èµ„æº")
        budget_method = "å…è´¹èµ„æº"
        scores.append(0.5)
    elif budget < 1000:
        reasoning.append("ğŸ’° **é¢„ç®—åˆ†æ**: é¢„ç®—é€‚ä¸­ï¼Œå¯é€‰æ‹©æ€§è´­ä¹°ä»˜è´¹è¯¾ç¨‹")
        budget_method = "ä»˜è´¹è¯¾ç¨‹"
        scores.append(0.7)
    else:
        reasoning.append("ğŸ’° **é¢„ç®—åˆ†æ**: é¢„ç®—å……è¶³ï¼Œæ¨èé«˜ç«¯å®šåˆ¶æ–¹æ¡ˆ")
        budget_method = "å®šåˆ¶æ–¹æ¡ˆ"
        scores.append(0.9)
    
    # å­¦ä¹ é£æ ¼é€‚é…
    style_adaptations = {
        "è§†è§‰å‹": "+ å›¾æ–‡è§†é¢‘èµ„æ–™",
        "å¬è§‰å‹": "+ éŸ³é¢‘è¯¾ç¨‹æ’­å®¢", 
        "åŠ¨æ‰‹å‹": "+ å®è·µé¡¹ç›®",
        "é˜…è¯»å‹": "+ ç”µå­ä¹¦æ–‡æ¡£"
    }
    style_adapt = style_adaptations[style]
    reasoning.append(f"ğŸ¨ **é£æ ¼é€‚é…**: æ£€æµ‹åˆ°{style}å­¦ä¹ åå¥½")
    
    # ç´§è¿«åº¦åˆ†æ
    if urgency == "ç´§æ€¥":
        reasoning.append("âš¡ **ç´§è¿«åº¦**: å­¦ä¹ ç›®æ ‡ç´§è¿«ï¼Œæ¨èå¼ºåŒ–è®­ç»ƒæ¨¡å¼")
        base_method = "å¼ºåŒ–è®­ç»ƒ"
        scores.append(0.8)
    else:
        scores.append(0.6)
    
    # ç»¼åˆæ¨è
    recommendation = f"{base_method} + {knowledge_method} + {budget_method}"
    
    # ç½®ä¿¡åº¦è®¡ç®—
    confidence = int(np.mean(scores) * 100)
    
    return recommendation, confidence, reasoning

def calculate_expected_effectiveness(method):
    """è®¡ç®—é¢„æœŸæ•ˆæœåˆ†æ•°"""
    effectiveness_scores = {
        "å¾®å­¦ä¹ ": 70, "ç³»ç»Ÿå­¦ä¹ ": 85, "å¼ºåŒ–è®­ç»ƒ": 90,
        "åˆ†å±‚æ•™å­¦": 80, "é¡¹ç›®å®è·µ": 85,
        "å…è´¹èµ„æº": 65, "ä»˜è´¹è¯¾ç¨‹": 80, "å®šåˆ¶æ–¹æ¡ˆ": 90
    }
    score = 70
    for key in effectiveness_scores:
        if key in method:
            score = max(score, effectiveness_scores[key])
    return score

def display_decision_tree_visualization():
    """ä½¿ç”¨æ–‡æœ¬å’Œè¡¨æ ¼æ˜¾ç¤ºå†³ç­–æ ‘ç»“æ„"""
    st.subheader("ğŸŒ³ å†³ç­–æ ‘ç»“æ„")
    
    # ä½¿ç”¨æ–‡æœ¬æ˜¾ç¤ºå†³ç­–æ ‘
    st.markdown("""
    **å†³ç­–æ ‘ç»“æ„ç¤ºæ„å›¾:**
    ```
    å­¦ä¹ éœ€æ±‚åˆ†æ (æ ¹èŠ‚ç‚¹)
    â”‚
    â”œâ”€â”€ æ—¶é—´å¯ç”¨æ€§ (å†³ç­–èŠ‚ç‚¹)
    â”‚   â”œâ”€â”€ <2å°æ—¶ â†’ ç¢ç‰‡åŒ–å­¦ä¹  [æ•ˆç”¨:75]
    â”‚   â”œâ”€â”€ 2-4å°æ—¶ â†’ ç³»ç»ŸåŒ–å­¦ä¹  [æ•ˆç”¨:85]
    â”‚   â””â”€â”€ >4å°æ—¶ â†’ å¼ºåŒ–è®­ç»ƒ [æ•ˆç”¨:90]
    â”‚
    â”œâ”€â”€ çŸ¥è¯†åŸºç¡€ (å†³ç­–èŠ‚ç‚¹)
    â”‚   â”œâ”€â”€ é›¶åŸºç¡€ â†’ åˆ†å±‚æ•™å­¦ [æ•ˆç”¨:80]
    â”‚   â”œâ”€â”€ æœ‰åŸºç¡€ â†’ é¡¹ç›®å®è·µ [æ•ˆç”¨:85]
    â”‚   â””â”€â”€ è¿›é˜¶è€… â†’ ä¸“é¢˜ç ”ç©¶ [æ•ˆç”¨:88]
    â”‚
    â”œâ”€â”€ å­¦ä¹ é¢„ç®— (å†³ç­–èŠ‚ç‚¹)
    â”‚   â”œâ”€â”€ <300å…ƒ â†’ å…è´¹èµ„æº [æ•ˆç”¨:70]
    â”‚   â”œâ”€â”€ 300-1000å…ƒ â†’ ä»˜è´¹è¯¾ç¨‹ [æ•ˆç”¨:82]
    â”‚   â””â”€â”€ >1000å…ƒ â†’ å®šåˆ¶æ–¹æ¡ˆ [æ•ˆç”¨:92]
    â”‚
    â””â”€â”€ å†…å®¹å¤æ‚åº¦ (å†³ç­–èŠ‚ç‚¹)
        â”œâ”€â”€ åŸºç¡€ â†’ å›¾æ–‡è®²è§£ [æ•ˆç”¨:78]
        â”œâ”€â”€ ä¸­ç­‰ â†’ æ¡ˆä¾‹æ•™å­¦ [æ•ˆç”¨:83]
        â””â”€â”€ å¤æ‚ â†’ é¡¹ç›®é©±åŠ¨ [æ•ˆç”¨:87]
    ```
    """)
    
    # å†³ç­–èŠ‚ç‚¹è¯¦æƒ…è¡¨æ ¼
    st.subheader("ğŸ“Š å†³ç­–èŠ‚ç‚¹è¯¦æƒ…")
    decision_data = {
        'å†³ç­–èŠ‚ç‚¹': ['æ—¶é—´è¯„ä¼°', 'çŸ¥è¯†è¯„ä¼°', 'é¢„ç®—è¯„ä¼°', 'å¤æ‚åº¦è¯„ä¼°'],
        'è¯„ä¼°å› ç´ ': ['æ¯æ—¥å¯ç”¨å­¦ä¹ æ—¶é—´', 'å½“å‰çŸ¥è¯†æ°´å¹³', 'æ¯æœˆå­¦ä¹ é¢„ç®—', 'å­¦ä¹ å†…å®¹éš¾åº¦'],
        'åˆ†æ”¯é€‰é¡¹': ['3ç§æ—¶é—´æ–¹æ¡ˆ', '3ç§åŸºç¡€æ–¹æ¡ˆ', '3ç§é¢„ç®—æ–¹æ¡ˆ', '3ç§éš¾åº¦æ–¹æ¡ˆ'],
        'å½±å“æƒé‡': ['30%', '25%', '25%', '20%']
    }
    
    df = pd.DataFrame(decision_data)
    st.dataframe(df, use_container_width=True, hide_index=True)

def display_utility_comparison():
    """æ˜¾ç¤ºæ•ˆç”¨å€¼å¯¹æ¯”"""
    st.subheader("ğŸ“ˆ å„å­¦ä¹ æ–¹æ¡ˆæ•ˆç”¨å€¼å¯¹æ¯”")
    
    # åˆ›å»ºæ•ˆç”¨å€¼æ•°æ®
    utility_data = pd.DataFrame({
        'å­¦ä¹ æ–¹æ¡ˆ': ['ç¢ç‰‡åŒ–å­¦ä¹ ', 'ç³»ç»ŸåŒ–å­¦ä¹ ', 'å¼ºåŒ–è®­ç»ƒ', 'åˆ†å±‚æ•™å­¦', 
                    'é¡¹ç›®å®è·µ', 'å…è´¹èµ„æº', 'ä»˜è´¹è¯¾ç¨‹', 'å®šåˆ¶æ–¹æ¡ˆ'],
        'æ•ˆç”¨å€¼': [75, 85, 90, 80, 85, 65, 80, 90],
        'ç±»å‹': ['æ—¶é—´æ–¹æ¡ˆ', 'æ—¶é—´æ–¹æ¡ˆ', 'æ—¶é—´æ–¹æ¡ˆ', 'åŸºç¡€æ–¹æ¡ˆ', 
                'åŸºç¡€æ–¹æ¡ˆ', 'é¢„ç®—æ–¹æ¡ˆ', 'é¢„ç®—æ–¹æ¡ˆ', 'é¢„ç®—æ–¹æ¡ˆ']
    })
    
    # ä½¿ç”¨Plotlyåˆ›å»ºæ¡å½¢å›¾
    try:
        fig = px.bar(
            utility_data, 
            x='å­¦ä¹ æ–¹æ¡ˆ', 
            y='æ•ˆç”¨å€¼', 
            color='ç±»å‹',
            title='å„å­¦ä¹ æ–¹æ¡ˆæ•ˆç”¨å€¼è¯„åˆ†å¯¹æ¯”',
            text='æ•ˆç”¨å€¼',
            color_discrete_map={
                'æ—¶é—´æ–¹æ¡ˆ': '#FF6B6B',
                'åŸºç¡€æ–¹æ¡ˆ': '#4ECDC4', 
                'é¢„ç®—æ–¹æ¡ˆ': '#45B7D1'
            }
        )
        
        # ç¾åŒ–å›¾è¡¨
        fig.update_traces(texttemplate='%{text}', textposition='outside')
        fig.update_layout(
            xaxis_title="å­¦ä¹ æ–¹æ¡ˆ",
            yaxis_title="æ•ˆç”¨å€¼",
            yaxis_range=[0, 100],
            showlegend=True
        )
        
        st.plotly_chart(fig, use_container_width=True)
        
    except Exception as e:
        # å¦‚æœPlotlyå‡ºé”™ï¼Œä½¿ç”¨StreamlitåŸç”Ÿå›¾è¡¨
        st.warning("äº¤äº’å¼å›¾è¡¨åŠ è½½ä¸­...")
        st.bar_chart(utility_data.set_index('å­¦ä¹ æ–¹æ¡ˆ')['æ•ˆç”¨å€¼'])

def show_detailed_analysis(time, level, budget, urgency, style):
    """æ˜¾ç¤ºè¯¦ç»†åˆ†ææŠ¥å‘Š"""
    
    st.subheader("ğŸ“‹ è¯¦ç»†åˆ†ææŠ¥å‘Š")
    
    col1, col2 = st.columns(2)
    
    with col1:
        st.markdown("#### ğŸ¯ æ¡ä»¶åˆ†æ")
        
        conditions = [
            {"æ¡ä»¶": "â° æ—¶é—´æ¡ä»¶", "é€‰æ‹©": time, "åˆ†æ": get_time_analysis(time)},
            {"æ¡ä»¶": "ğŸ“ çŸ¥è¯†æ¡ä»¶", "é€‰æ‹©": level, "åˆ†æ": get_level_analysis(level)},
            {"æ¡ä»¶": "ğŸ’° é¢„ç®—æ¡ä»¶", "é€‰æ‹©": f"{budget}å…ƒ/æœˆ", "åˆ†æ": get_budget_analysis(budget)},
            {"æ¡ä»¶": "ğŸ¨ é£æ ¼æ¡ä»¶", "é€‰æ‹©": style, "åˆ†æ": get_style_analysis(style)},
            {"æ¡ä»¶": "âš¡ ç´§è¿«åº¦", "é€‰æ‹©": urgency, "åˆ†æ": get_urgency_analysis(urgency)}
        ]
        
        for condition in conditions:
            with st.expander(f"{condition['æ¡ä»¶']}: {condition['é€‰æ‹©']}"):
                st.write(condition['åˆ†æ'])
    
    with col2:
        st.markdown("#### ğŸ’¡ ä¼˜åŒ–å»ºè®®")
        
        suggestions = [
            "ğŸ“… **åˆ¶å®šè®¡åˆ’**: æ ¹æ®å¯ç”¨æ—¶é—´å®‰æ’å›ºå®šå­¦ä¹ æ—¶æ®µ",
            "ğŸ¯ **ç›®æ ‡æ˜ç¡®**: è®¾å®šå…·ä½“å¯è¡¡é‡çš„å­¦ä¹ ç›®æ ‡",
            "ğŸ”„ **å®šæœŸå¤ä¹ **: å®‰æ’æ—¶é—´å›é¡¾å·²å­¦å†…å®¹",
            "ğŸ” **ç²¾é€‰èµ„æº**: ä¼˜å…ˆé€‰æ‹©è¯„ä»·é«˜çš„å­¦ä¹ ææ–™",
            "ğŸ‘¥ **ç¤¾ç¾¤å­¦ä¹ **: åŠ å…¥å­¦ä¹ å°ç»„äº’ç›¸ç£ä¿ƒ",
            "ğŸ“ **å®è·µåº”ç”¨**: å­¦å®Œç«‹å³åŠ¨æ‰‹å®è·µ",
            "â±ï¸ **æ—¶é—´ç®¡ç†**: ä½¿ç”¨ç•ªèŒ„å·¥ä½œæ³•æé«˜æ•ˆç‡",
            "ğŸ“Š **è¿›åº¦è¿½è¸ª**: è®°å½•å­¦ä¹ è¿›åº¦å’Œæˆæœ"
        ]
        
        for suggestion in suggestions:
            st.write(f"â€¢ {suggestion}")

def get_time_analysis(time):
    analyses = {
        "1å°æ—¶ä»¥ä¸‹": "æ—¶é—´éå¸¸æœ‰é™ï¼Œå»ºè®®åˆ©ç”¨ç¢ç‰‡æ—¶é—´ï¼Œé‡ç‚¹å­¦ä¹ æ ¸å¿ƒæ¦‚å¿µ",
        "1-2å°æ—¶": "æ—¶é—´é€‚ä¸­ï¼Œå¯ä»¥å®‰æ’å›ºå®šå­¦ä¹ æ—¶æ®µï¼Œèšç„¦å…³é”®æŠ€èƒ½",
        "2-4å°æ—¶": "æ—¶é—´å……è¶³ï¼Œé€‚åˆç³»ç»ŸåŒ–å­¦ä¹ ï¼Œå»ºç«‹å®Œæ•´çŸ¥è¯†ä½“ç³»",
        "4å°æ—¶ä»¥ä¸Š": "æ—¶é—´å……è£•ï¼Œå¯ä»¥è¿›è¡Œæ·±åº¦å­¦ä¹ ï¼Œç»“åˆç†è®ºä¸å®è·µ"
    }
    return analyses.get(time, "æ—¶é—´æ¡ä»¶åˆ†æ")

def get_level_analysis(level):
    analyses = {
        "é›¶åŸºç¡€": "ä»åŸºç¡€æ¦‚å¿µå¼€å§‹ï¼Œéœ€è¦å¤§é‡ç¤ºä¾‹å’Œç»ƒä¹ ï¼Œå»ºè®®å¾ªåºæ¸è¿›",
        "åˆçº§": "å·²æœ‰åŸºæœ¬äº†è§£ï¼Œå¯ä»¥å¿«é€Ÿå›é¡¾åŸºç¡€åè¿›å…¥æ ¸å¿ƒå†…å®¹",
        "ä¸­çº§": "å…·å¤‡ä¸€å®šåŸºç¡€ï¼Œé€‚åˆé¡¹ç›®é©±åŠ¨å­¦ä¹ ï¼Œé‡ç‚¹çªç ´éš¾ç‚¹",
        "é«˜çº§": "åŸºç¡€æ‰å®ï¼Œå¯ä»¥ä¸“æ³¨å‰æ²¿æŠ€æœ¯å’Œæ·±åº¦ä¼˜åŒ–"
    }
    return analyses.get(level, "çŸ¥è¯†æ°´å¹³åˆ†æ")

def get_budget_analysis(budget):
    if budget < 300:
        return "é¢„ç®—æœ‰é™ï¼Œä½†æœ‰å¾ˆå¤šä¼˜è´¨å…è´¹èµ„æºå¯ç”¨ï¼Œå¦‚å¼€æºæ•™ç¨‹ã€å…¬å¼€è¯¾ç­‰"
    elif budget < 1000:
        return "é¢„ç®—é€‚ä¸­ï¼Œå¯ä»¥é€‰æ‹©æ€§è´­ä¹°å…³é”®è¯¾ç¨‹ï¼Œç»“åˆå…è´¹èµ„æºä½¿ç”¨"
    else:
        return "é¢„ç®—å……è¶³ï¼Œå¯ä»¥è€ƒè™‘é«˜ç«¯å®šåˆ¶æœåŠ¡ï¼Œè·å¾—ä¸ªæ€§åŒ–æŒ‡å¯¼"

def get_style_analysis(style):
    analyses = {
        "è§†è§‰å‹": "é€‚åˆè§†é¢‘æ•™ç¨‹ã€å›¾è¡¨ã€æ€ç»´å¯¼å›¾ç­‰å¯è§†åŒ–å­¦ä¹ ææ–™",
        "å¬è§‰å‹": "é€‚åˆéŸ³é¢‘è¯¾ç¨‹ã€æ’­å®¢ã€è®²è§£å½•éŸ³ç­‰å¬è§‰å­¦ä¹ æ–¹å¼",
        "åŠ¨æ‰‹å‹": "é€‚åˆç¼–ç¨‹å®è·µã€é¡¹ç›®åˆ¶ä½œã€å®éªŒæ“ä½œç­‰åŠ¨æ‰‹å­¦ä¹ ",
        "é˜…è¯»å‹": "é€‚åˆæ–‡æ¡£é˜…è¯»ã€ç”µå­ä¹¦ã€æŠ€æœ¯æ–‡ç« ç­‰æ–‡å­—å­¦ä¹ "
    }
    return analyses.get(style, "å­¦ä¹ é£æ ¼åˆ†æ")

def get_urgency_analysis(urgency):
    analyses = {
        "å®½æ¾": "å­¦ä¹ è¿›åº¦å¯ä»¥æ”¾æ…¢ï¼Œæ³¨é‡ç†è§£æ·±åº¦å’ŒåŸºç¡€ç‰¢å›º",
        "ä¸­ç­‰": "éœ€è¦åˆ¶å®šæ˜ç¡®å­¦ä¹ è®¡åˆ’ï¼ŒæŒ‰éƒ¨å°±ç­æ¨è¿›",
        "ç´§æ€¥": "éœ€è¦å¼ºåŒ–è®­ç»ƒï¼Œèšç„¦æ ¸å¿ƒæŠ€èƒ½ï¼Œå¿«é€Ÿæå‡"
    }
    return analyses.get(urgency, "ç´§è¿«åº¦åˆ†æ")

if __name__ == "__main__":
    main()